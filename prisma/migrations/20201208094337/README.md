# Migration `20201208094337`

This migration has been generated by Gál Péter at 12/8/2020, 10:43:37 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE `badge` DROP FOREIGN KEY `badge_ibfk_1`

ALTER TABLE `badge` DROP FOREIGN KEY `badge_ibfk_2`

ALTER TABLE `badgecompletion` DROP FOREIGN KEY `badgecompletion_ibfk_2`

ALTER TABLE `badgecompletion` DROP FOREIGN KEY `badgecompletion_ibfk_1`

ALTER TABLE `invitations` DROP FOREIGN KEY `invitations_ibfk_1`

ALTER TABLE `invitations` DROP FOREIGN KEY `invitations_ibfk_2`

ALTER TABLE `student` DROP FOREIGN KEY `student_ibfk_2`

ALTER TABLE `student` DROP FOREIGN KEY `student_ibfk_1`

ALTER TABLE `table` DROP FOREIGN KEY `table_ibfk_2`

ALTER TABLE `table` DROP FOREIGN KEY `table_ibfk_1`

ALTER TABLE `task` DROP FOREIGN KEY `task_ibfk_1`

ALTER TABLE `taskcompletion` DROP FOREIGN KEY `taskcompletion_ibfk_2`

ALTER TABLE `taskcompletion` DROP FOREIGN KEY `taskcompletion_ibfk_1`

CREATE TABLE `Student` (
    `userid` INT NOT NULL,
    `tableid` INT NOT NULL,

    PRIMARY KEY (`userid`,`tableid`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `Table` (
    `id` INT NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(191) NOT NULL,
    `teacherId` INT NOT NULL,
    `iconid` INT,
    `createdAt` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),

    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `TaskCompletion` (
    `userid` INT NOT NULL,
    `taskid` INT NOT NULL,

    PRIMARY KEY (`userid`,`taskid`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `BadgeCompletion` (
    `userid` INT NOT NULL,
    `badgeid` INT NOT NULL,

    PRIMARY KEY (`userid`,`badgeid`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `Task` (
    `id` INT NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(191) NOT NULL,
    `points` INT NOT NULL,
    `description` VARCHAR(191),
    `endsAt` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    `tableId` INT,

    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `Badge` (
    `id` INT NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(191),
    `imageid` INT,
    `tableId` INT,

    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `Image` (
    `id` INT NOT NULL AUTO_INCREMENT,
    `width` INT NOT NULL,
    `height` INT NOT NULL,
    `path` VARCHAR(191) NOT NULL,

    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `Invitations` (
    `id` INT NOT NULL AUTO_INCREMENT,
    `studentid` INT NOT NULL,
    `tableid` INT NOT NULL,
    `createdAt` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
UNIQUE INDEX `Invitations.studentid_tableid_unique`(`studentid`,
`tableid`),

    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

DROP TABLE `badge`

DROP TABLE `badgecompletion`

DROP TABLE `image`

DROP TABLE `invitations`

DROP TABLE `student`

DROP TABLE `table`

DROP TABLE `task`

DROP TABLE `taskcompletion`

ALTER TABLE `Student` ADD FOREIGN KEY (`userid`) REFERENCES `users`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `Student` ADD FOREIGN KEY (`tableid`) REFERENCES `Table`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `Table` ADD FOREIGN KEY (`teacherId`) REFERENCES `users`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `Table` ADD FOREIGN KEY (`iconid`) REFERENCES `Image`(`id`) ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE `TaskCompletion` ADD FOREIGN KEY (`userid`) REFERENCES `users`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `TaskCompletion` ADD FOREIGN KEY (`taskid`) REFERENCES `Task`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `BadgeCompletion` ADD FOREIGN KEY (`userid`) REFERENCES `users`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `BadgeCompletion` ADD FOREIGN KEY (`badgeid`) REFERENCES `Badge`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `Task` ADD FOREIGN KEY (`tableId`) REFERENCES `Table`(`id`) ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE `Badge` ADD FOREIGN KEY (`imageid`) REFERENCES `Image`(`id`) ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE `Badge` ADD FOREIGN KEY (`tableId`) REFERENCES `Table`(`id`) ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE `Invitations` ADD FOREIGN KEY (`studentid`) REFERENCES `users`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `Invitations` ADD FOREIGN KEY (`tableid`) REFERENCES `Table`(`id`) ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201119073240..20201208094337
--- datamodel.dml
+++ datamodel.dml
@@ -2,9 +2,9 @@
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 datasource db {
   provider = "mysql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -119,12 +119,14 @@
 model Invitations {
   id            Int       @default(autoincrement()) @id
   studentid     Int
-  student       User   @relation(references: [id], fields: [studentid])
+  student       User      @relation(references: [id], fields: [studentid])
   tableid       Int
   table         Table     @relation(references: [id], fields: [tableid])
   createdAt     DateTime  @default(now())
+
+  @@unique([studentid, tableid])
 }
 model VerificationRequest {
   id         Int       @default(autoincrement()) @id
```


